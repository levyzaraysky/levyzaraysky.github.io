<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutorial Group Finder</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align items to the start to allow scrolling */
            min-height: 100vh;
            padding: 2rem 1rem; /* Add padding for mobile view */
            box-sizing: border-box;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e2e8f0;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
    </style>
</head>
<body>
    <div class="max-w-4xl w-full bg-white p-8 rounded-xl shadow-lg space-y-8">
        <h1 class="text-4xl font-bold text-center text-gray-800 mb-6">Tutorial Group Finder</h1>

        <!-- User ID Display -->
        <div class="bg-blue-50 border border-blue-200 text-blue-800 px-6 py-4 rounded-lg flex flex-col md:flex-row items-center justify-between shadow-sm">
            <p class="text-lg font-medium mb-2 md:mb-0">Your User ID:</p>
            <span id="userIdDisplay" class="font-mono text-base bg-blue-100 px-4 py-2 rounded-md break-all">Loading...</span>
        </div>

        <!-- Google Sign-In Button -->
        <div class="text-center">
            <button id="googleSignInButton"
                    class="bg-red-600 text-white py-2 px-6 rounded-md shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-150 ease-in-out flex items-center justify-center mx-auto">
                <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12.000 4.750c-2.430 0-4.700 1.010-6.320 2.760l-3.680 3.680c-0.390 0.390-0.390 1.020 0 1.410l3.680 3.680c1.620 1.750 3.890 2.760 6.320 2.760c2.430 0 4.700-1.010 6.320-2.760l3.680-3.680c0.390-0.390 0.390-1.020 0-1.410l-3.680-3.680c-1.620-1.750-3.890-2.760-6.320-2.760zM12.000 6.250c1.870 0 3.610 0.770 4.880 2.040l-1.410 1.410c-0.890-0.890-2.080-1.410-3.470-1.410c-2.760 0-5.000 2.240-5.000 5.000s2.240 5.000 5.000 5.000c1.390 0 2.580-0.520 3.470-1.410l1.410 1.410c-1.270 1.270-3.010 2.040-4.880 2.040c-4.140 0-7.500-3.360-7.500-7.500s3.360-7.500 7.500-7.500z"/>
                    <path d="M12.000 10.000c-1.100 0-2.000 0.900-2.000 2.000s0.900 2.000 2.000 2.000s2.000-0.900 2.000-2.000s-0.900-2.000-2.000-2.000z"/>
                </svg>
                Sign in with Google
            </button>
        </div>

        <!-- Post a New Study Group Section -->
        <section class="bg-gray-50 p-6 rounded-xl shadow-md">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Post a New Study Group</h2>
            <form id="groupForm" class="space-y-4">
                <div>
                    <label for="groupName" class="block text-sm font-medium text-gray-700 mb-1">Group Name / Subject</label>
                    <input type="text" id="groupName" name="groupName" required
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                           placeholder="e.g., Calculus I Review, Python Study Session">
                </div>
                <div>
                    <label for="groupTime" class="block text-sm font-medium text-gray-700 mb-1">Time Available</label>
                    <input type="text" id="groupTime" name="groupTime" required
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                           placeholder="e.g., Mon, Wed 3-5 PM; Flexible evenings">
                </div>
                <div>
                    <label for="groupArea" class="block text-sm font-medium text-gray-700 mb-1">Area / Location</label>
                    <input type="text" id="groupArea" name="groupArea" required
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                           placeholder="e.g., Library 3rd Floor, Math Dept. Lounge, Zoom">
                </div>
                <button type="submit"
                        class="w-full bg-blue-600 text-white py-2 px-4 rounded-md shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                    Post Group
                </button>
            </form>
        </section>

        <!-- Available Study Groups Section -->
        <section class="bg-gray-50 p-6 rounded-xl shadow-md">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Available Study Groups</h2>
            <div id="groupsList" class="space-y-4">
                <!-- Study groups will be dynamically loaded here -->
                <p id="noGroupsMessage" class="text-gray-500 text-center py-4">No study groups posted yet. Be the first!</p>
            </div>
        </section>

        <!-- Custom Modal for Messages (instead of alert) -->
        <div id="messageModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                <h3 id="modalTitle" class="text-xl font-semibold text-gray-800 mb-3"></h3>
                <p id="modalMessage" class="text-gray-700 mb-5"></p>
                <button id="modalCloseButton" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">OK</button>
            </div>
        </div>

    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase config and app ID
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
    apiKey: "AIzaSyB_5UTrJUUVsoPIqWJcwvcPk1JsqvOzFdg",
    authDomain: "evan-websitw.firebaseapp.com",
    projectId: "evan-websitw",
    storageBucket: "evan-websitw.firebasestorage.app",
    messagingSenderId: "319875261277",
    appId: "1:319875261277:web:21a2481362b0323383beb4",
    measurementId: "G-QNQT234YPT"
  };

        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null; // To store the current user's ID

        // Get references to HTML elements
        const groupForm = document.getElementById('groupForm');
        const groupsList = document.getElementById('groupsList');
        const noGroupsMessage = document.getElementById('noGroupsMessage');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const messageModal = document.getElementById('messageModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalCloseButton = document.getElementById('modalCloseButton');
        const googleSignInButton = document.getElementById('googleSignInButton'); // New: Google Sign-In button

        /**
         * Displays a custom modal message to the user.
         * @param {string} title - The title of the message.
         * @param {string} message - The content of the message.
         */
        function showModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            messageModal.classList.remove('hidden');
        }

        // Close the modal when the OK button is clicked
        modalCloseButton.addEventListener('click', () => {
            messageModal.classList.add('hidden');
        });

        // Initialize Firebase and set up authentication
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Listen for authentication state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // User is signed in.
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        console.log("Authenticated with user ID:", userId);
                        // Once authenticated, start listening for group data
                        setupRealtimeGroupListener();
                    } else {
                        // User is signed out. Attempt to sign in with custom token or anonymously.
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Error during initial authentication:", error);
                            showModal("Authentication Error", "Failed to sign in. Please try again or use Google Sign-In.");
                            // If anonymous sign-in also fails, generate a random ID for display purposes
                            userId = crypto.randomUUID();
                            userIdDisplay.textContent = `Error: ${userId.substring(0, 8)}...`;
                        }
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showModal("Initialization Error", "Failed to initialize the application. Please check your console for details.");
            }
        }

        /**
         * Handles Google Sign-In using a popup.
         */
        googleSignInButton.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                // The onAuthStateChanged listener will handle updating the UI
            } catch (error) {
                console.error("Error during Google Sign-In:", error);
                let errorMessage = "Failed to sign in with Google. Please try again.";
                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = "Google Sign-In window was closed. Please try again.";
                } else if (error.code === 'auth/cancelled-popup-request') {
                    errorMessage = "Another sign-in popup was already open. Please complete or close it.";
                }
                showModal("Google Sign-In Error", errorMessage);
            }
        });

        /**
         * Sets up a real-time listener for study groups from Firestore.
         * Displays them on the UI.
         */
        function setupRealtimeGroupListener() {
            // Define the collection path based on the app ID for public data
            const groupsCollectionRef = collection(db, `artifacts/${appId}/public/data/studyGroups`);

            // Listen for real-time updates to the 'studyGroups' collection
            onSnapshot(groupsCollectionRef, (snapshot) => {
                groupsList.innerHTML = ''; // Clear existing list
                if (snapshot.empty) {
                    noGroupsMessage.classList.remove('hidden'); // Show message if no groups
                } else {
                    noGroupsMessage.classList.add('hidden'); // Hide message if groups exist
                    snapshot.forEach((doc) => {
                        const group = doc.data();
                        const groupId = doc.id;
                        createGroupCard(group, groupId);
                    });
                }
            }, (error) => {
                console.error("Error fetching study groups:", error);
                showModal("Data Fetch Error", "Failed to load study groups. Please try again later.");
            });
        }

        /**
         * Creates and appends a study group card to the list.
         * @param {object} group - The group data from Firestore.
         * @param {string} groupId - The document ID of the group.
         */
        function createGroupCard(group, groupId) {
            const groupCard = document.createElement('div');
            groupCard.className = 'bg-white p-5 rounded-lg shadow-sm border border-gray-200 flex flex-col md:flex-row md:items-center justify-between space-y-3 md:space-y-0 md:space-x-4';
            groupCard.innerHTML = `
                <div class="flex-grow">
                    <h3 class="text-xl font-semibold text-gray-800">${group.name}</h3>
                    <p class="text-gray-600 text-sm mt-1">
                        <span class="font-medium">Time:</span> ${group.time}
                    </p>
                    <p class="text-gray-600 text-sm">
                        <span class="font-medium">Area:</span> ${group.area}
                    </p>
                    <p class="text-gray-500 text-xs mt-2">
                        <span class="font-medium">Members:</span> ${group.members ? group.members.length : 0}
                    </p>
                </div>
                <button data-id="${groupId}"
                        class="join-button bg-green-500 text-white py-2 px-5 rounded-md shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-150 ease-in-out whitespace-nowrap">
                    Join Group
                </button>
            `;
            groupsList.appendChild(groupCard);

            // Add event listener to the "Join Group" button
            groupCard.querySelector('.join-button').addEventListener('click', async (event) => {
                const idToJoin = event.target.dataset.id;
                await joinGroup(idToJoin);
            });
        }

        /**
         * Handles the submission of the new group form.
         * Adds the new group to Firestore.
         * @param {Event} event - The form submission event.
         */
        groupForm.addEventListener('submit', async (event) => {
            event.preventDefault(); // Prevent default form submission

            if (!userId) {
                showModal("Authentication Required", "Please sign in with Google or wait for anonymous authentication to post a group.");
                return;
            }

            const groupName = document.getElementById('groupName').value.trim();
            const groupTime = document.getElementById('groupTime').value.trim();
            const groupArea = document.getElementById('groupArea').value.trim();

            if (!groupName || !groupTime || !groupArea) {
                showModal("Missing Information", "Please fill in all fields to post a new group.");
                return;
            }

            try {
                const groupsCollectionRef = collection(db, `artifacts/${appId}/public/data/studyGroups`);
                await addDoc(groupsCollectionRef, {
                    name: groupName,
                    time: groupTime,
                    area: groupArea,
                    createdAt: new Date(),
                    createdBy: userId, // Store who created the group
                    members: [userId] // Creator is automatically a member
                });
                groupForm.reset(); // Clear the form
                showModal("Success!", "Your study group has been posted!");
            } catch (error) {
                console.error("Error adding document: ", error);
                showModal("Error Posting Group", "Failed to post your study group. Please try again.");
            }
        });

        /**
         * Adds the current user to the members list of a specific group.
         * @param {string} groupId - The ID of the group to join.
         */
        async function joinGroup(groupId) {
            if (!userId) {
                showModal("Authentication Required", "Please sign in with Google or wait for anonymous authentication to join a group.");
                return;
            }

            try {
                const groupDocRef = doc(db, `artifacts/${appId}/public/data/studyGroups`, groupId);
                await updateDoc(groupDocRef, {
                    members: arrayUnion(userId) // Add user ID to the members array if not already present
                });
                showModal("Group Joined!", "You have successfully joined the group!");
            } catch (error) {
                console.error("Error joining group:", error);
                showModal("Error Joining Group", "Failed to join the group. Please try again.");
            }
        }

        // Initialize Firebase when the window loads
        window.onload = initializeFirebase;
    </script>
</body>
</html>
